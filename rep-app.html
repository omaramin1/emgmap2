<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EMG Field Rep</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg: #0a0a12;
            --card: #12121f;
            --accent: #00d4ff;
            --success: #00ff88;
            --warning: #ffd93d;
            --danger: #ff6b6b;
            --text: #ffffff;
            --muted: #666680;
            --gold: #ffd700;
        }
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            touch-action: manipulation;
        }

        /* ===== MAIN LAYOUT ===== */
        .app { display: flex; flex-direction: column; height: 100%; }

        /* ===== DOOR COUNTER HEADER ===== */
        .door-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a12 100%);
            padding: 1rem;
            padding-top: calc(1rem + env(safe-area-inset-top));
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .door-counter {
            flex: 1;
            text-align: center;
        }
        .door-count {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }
        .door-count .current { color: var(--success); }
        .door-count .divider { color: var(--muted); font-weight: 400; }
        .door-count .goal { color: var(--muted); font-size: 1.5rem; }
        .door-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
        .door-progress {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .door-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 3px;
            transition: width 0.3s;
        }

        .stat-box {
            text-align: center;
            min-width: 50px;
        }
        .stat-box-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .stat-box-value.deals { color: var(--success); }
        .stat-box-value.callbacks { color: var(--warning); }
        .stat-box-value.rate { color: var(--accent); }
        .stat-box-label { font-size: 0.6rem; color: var(--muted); }

        /* ===== MAP SECTION ===== */
        .map-section {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        #map { width: 100%; height: 100%; }

        /* Zone Intel Overlay */
        .zone-intel {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            right: 0.75rem;
            z-index: 1000;
            background: rgba(10,10,18,0.95);
            border-radius: 12px;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }
        .zone-intel.active { display: block; }
        .zone-intel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .zone-name { font-weight: 700; font-size: 1rem; }
        .zone-score {
            font-size: 1.5rem;
            font-weight: 800;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            background: var(--success);
            color: var(--bg);
        }
        .zone-score.medium { background: var(--warning); }
        .zone-score.low { background: var(--danger); }
        .zone-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .zone-badge {
            font-size: 0.7rem;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-weight: 600;
        }
        .zone-badge.lmi { background: rgba(0,255,136,0.2); color: var(--success); }
        .zone-badge.auto-qualify { background: var(--gold); color: var(--bg); }
        .zone-badge.mhp { background: rgba(255,215,0,0.3); color: var(--gold); }
        .zone-badge.fresh { background: var(--success); color: var(--bg); }
        .zone-badge.electric { background: rgba(0,212,255,0.2); color: var(--accent); }

        /* Pitch Helper */
        .pitch-helper {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .pitch-line {
            font-size: 0.8rem;
            color: var(--accent);
            font-style: italic;
        }

        /* GPS Button */
        .gps-btn {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--card);
            border: 2px solid var(--accent);
            color: var(--accent);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .gps-btn:active { transform: scale(0.95); }
        .gps-btn.tracking { background: var(--accent); color: var(--bg); animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0,212,255,0.4); }
            50% { box-shadow: 0 0 0 15px rgba(0,212,255,0); }
        }

        /* ===== QUICK ACTION BUTTONS ===== */
        .action-section {
            background: var(--card);
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Primary Door Actions - Big Buttons */
        .door-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .door-btn {
            padding: 1.25rem 0.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .door-btn:active { transform: scale(0.95); }
        .door-btn .icon { font-size: 1.5rem; }
        .door-btn.deal {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: var(--bg);
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
        }
        .door-btn.callback {
            background: linear-gradient(135deg, #ffd93d 0%, #f0c000 100%);
            color: var(--bg);
            box-shadow: 0 4px 15px rgba(255,217,61,0.3);
        }
        .door-btn.not-home {
            background: linear-gradient(135deg, #666680 0%, #4a4a5c 100%);
            color: white;
        }

        /* Secondary Actions Row */
        .secondary-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.4rem;
        }
        .sec-btn {
            padding: 0.75rem 0.25rem;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
        }
        .sec-btn:active { background: rgba(255,255,255,0.1); }
        .sec-btn .icon { font-size: 1.1rem; }
        .sec-btn.no-interest { color: var(--danger); border-color: rgba(255,107,107,0.3); }
        .sec-btn.dnc { color: var(--danger); border-color: rgba(255,107,107,0.5); background: rgba(255,107,107,0.1); }

        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            display: flex;
            background: var(--bg);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: none;
            color: var(--muted);
            font-size: 0.6rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            cursor: pointer;
        }
        .nav-btn .icon { font-size: 1.3rem; }
        .nav-btn.active { color: var(--accent); }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 5000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card);
            width: 100%;
            max-width: 500px;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg);
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Lead Form */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 0.3rem; }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 80px; resize: none; }
        .form-row { display: flex; gap: 0.75rem; }
        .form-row .form-group { flex: 1; }

        .housing-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .housing-btn {
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            text-align: center;
        }
        .housing-btn.selected { border-color: var(--accent); background: rgba(0,212,255,0.1); }
        .housing-btn .icon { font-size: 1.5rem; display: block; margin-bottom: 0.25rem; }

        .photo-capture {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .photo-btn {
            flex: 1;
            padding: 1rem;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            background: var(--bg);
            color: var(--muted);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .photo-btn .icon { font-size: 2rem; }
        .photo-btn.has-photo { border-color: var(--success); color: var(--success); }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            background: linear-gradient(90deg, var(--accent), var(--success));
            color: var(--bg);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
        }
        .submit-btn:active { transform: scale(0.98); }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .stat-card {
            background: var(--bg);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }
        .stat-card-value {
            font-size: 2rem;
            font-weight: 800;
        }
        .stat-card-label { font-size: 0.7rem; color: var(--muted); }
        .stat-card.highlight { border: 2px solid var(--success); }
        .stat-card.highlight .stat-card-value { color: var(--success); }

        /* Callbacks List */
        .callbacks-list { max-height: 300px; overflow-y: auto; }
        .callback-item {
            background: var(--bg);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .callback-info { flex: 1; }
        .callback-name { font-weight: 600; }
        .callback-notes { font-size: 0.75rem; color: var(--muted); }
        .callback-actions { display: flex; gap: 0.5rem; }
        .callback-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        .callback-btn.call { background: var(--success); color: var(--bg); }
        .callback-btn.nav { background: var(--accent); color: var(--bg); }

        /* Routes Panel */
        .routes-list { max-height: 400px; overflow-y: auto; }
        .route-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .route-item:active { background: rgba(255,255,255,0.05); }
        .route-item.selected { border-color: var(--accent); }
        .route-item-score {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--success);
            color: var(--bg);
            font-weight: 800;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .route-item-score.medium { background: var(--warning); }
        .route-item-score.low { background: var(--danger); }
        .route-item-info { flex: 1; }
        .route-item-name { font-weight: 600; }
        .route-item-meta { font-size: 0.75rem; color: var(--muted); }
        .route-item-badges { display: flex; gap: 0.3rem; margin-top: 0.25rem; }

        /* Leaderboard */
        .leaderboard { margin-top: 1rem; }
        .leaderboard-title { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .leaderboard-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }
        .leaderboard-rank.gold { background: var(--gold); color: var(--bg); }
        .leaderboard-rank.silver { background: #c0c0c0; color: var(--bg); }
        .leaderboard-rank.bronze { background: #cd7f32; color: var(--bg); }
        .leaderboard-name { flex: 1; }
        .leaderboard-score { font-weight: 700; color: var(--accent); }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: calc(1rem + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--card);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            z-index: 9999;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { border: 2px solid var(--success); }
        .toast.warning { border: 2px solid var(--warning); }
        .toast.deal { background: var(--success); color: var(--bg); }

        /* Hidden file input */
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Door Counter Header -->
        <header class="door-header">
            <div class="stat-box">
                <div class="stat-box-value deals" id="dealsCount">0</div>
                <div class="stat-box-label">DEALS</div>
            </div>
            <div class="door-counter">
                <div class="door-count">
                    <span class="current" id="doorCount">0</span><span class="divider">/</span><span class="goal">150</span>
                </div>
                <div class="door-label">Doors Today</div>
                <div class="door-progress">
                    <div class="door-progress-fill" id="doorProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value rate" id="closeRate">0%</div>
                <div class="stat-box-label">CLOSE</div>
            </div>
        </header>

        <!-- Map Section -->
        <section class="map-section">
            <div id="map"></div>

            <!-- Zone Intel Overlay -->
            <div class="zone-intel" id="zoneIntel">
                <div class="zone-intel-header">
                    <div class="zone-name" id="zoneName">Select a Zone</div>
                    <div class="zone-score" id="zoneScore">--</div>
                </div>
                <div class="zone-badges" id="zoneBadges"></div>
                <div class="pitch-helper">
                    <div class="pitch-line" id="pitchLine">"You already qualify for the $6,000 federal rebate"</div>
                </div>
            </div>

            <!-- GPS Button -->
            <button class="gps-btn" id="gpsBtn" onclick="toggleGPS()">üìç</button>
        </section>

        <!-- Quick Action Buttons -->
        <section class="action-section">
            <div class="door-actions">
                <button class="door-btn deal" onclick="logDoor('deal')">
                    <span class="icon">üí∞</span>
                    DEAL
                </button>
                <button class="door-btn callback" onclick="openCallbackModal()">
                    <span class="icon">üìû</span>
                    CALLBACK
                </button>
                <button class="door-btn not-home" onclick="logDoor('notHome')">
                    <span class="icon">üè†</span>
                    NOT HOME
                </button>
            </div>
            <div class="secondary-actions">
                <button class="sec-btn" onclick="logDoor('noAnswer')">
                    <span class="icon">üö™</span>
                    No Answer
                </button>
                <button class="sec-btn no-interest" onclick="logDoor('noInterest')">
                    <span class="icon">‚úã</span>
                    No Interest
                </button>
                <button class="sec-btn" onclick="logDoor('other')">
                    <span class="icon">üìù</span>
                    Other
                </button>
                <button class="sec-btn dnc" onclick="logDoor('dnc')">
                    <span class="icon">üö´</span>
                    DNC
                </button>
            </div>
        </section>

        <!-- Bottom Nav -->
        <nav class="bottom-nav">
            <button class="nav-btn active" id="navMap" onclick="showPanel('map')">
                <span class="icon">üó∫Ô∏è</span>
                Map
            </button>
            <button class="nav-btn" id="navRoutes" onclick="showPanel('routes')">
                <span class="icon">üìç</span>
                Routes
            </button>
            <button class="nav-btn" id="navCallbacks" onclick="showPanel('callbacks')">
                <span class="icon">üìû</span>
                Callbacks
            </button>
            <button class="nav-btn" id="navStats" onclick="showPanel('stats')">
                <span class="icon">üìä</span>
                Stats
            </button>
        </nav>
    </div>

    <!-- Callback Modal -->
    <div class="modal" id="callbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Log Callback</div>
                <button class="modal-close" onclick="closeModal('callbackModal')">√ó</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="cbName" placeholder="Homeowner name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="cbPhone" placeholder="(555) 555-5555">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Address</label>
                <input type="text" class="form-input" id="cbAddress" placeholder="123 Main St">
            </div>
            <div class="form-group">
                <label class="form-label">Housing Type (for kWh estimate)</label>
                <div class="housing-types">
                    <button class="housing-btn" data-type="mhp" onclick="selectHousing(this)">
                        <span class="icon">üè†</span>
                        Mobile Home
                    </button>
                    <button class="housing-btn" data-type="sfh" onclick="selectHousing(this)">
                        <span class="icon">üè°</span>
                        Single Family
                    </button>
                    <button class="housing-btn" data-type="apt" onclick="selectHousing(this)">
                        <span class="icon">üè¢</span>
                        Apartment
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-input form-textarea" id="cbNotes" placeholder="Best time to call, interests, objections..."></textarea>
            </div>
            <div class="photo-capture">
                <button class="photo-btn" id="billPhotoBtn" onclick="capturePhoto('bill')">
                    <span class="icon">üìÑ</span>
                    Bill Photo
                </button>
                <button class="photo-btn" id="homePhotoBtn" onclick="capturePhoto('home')">
                    <span class="icon">üè†</span>
                    Home Photo
                </button>
            </div>
            <button class="submit-btn" onclick="saveCallback()">Save Callback</button>
        </div>
    </div>

    <!-- Routes Modal -->
    <div class="modal" id="routesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Select Route</div>
                <button class="modal-close" onclick="closeModal('routesModal')">√ó</button>
            </div>
            <div class="routes-list" id="routesList"></div>
        </div>
    </div>

    <!-- Callbacks Modal -->
    <div class="modal" id="callbacksModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Today's Callbacks (<span id="callbackCount">0</span>)</div>
                <button class="modal-close" onclick="closeModal('callbacksModal')">√ó</button>
            </div>
            <div class="callbacks-list" id="callbacksList"></div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Today's Stats</div>
                <button class="modal-close" onclick="closeModal('statsModal')">√ó</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-card-value" id="statDeals">0</div>
                    <div class="stat-card-label">DEALS CLOSED</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="statDoors">0</div>
                    <div class="stat-card-label">DOORS KNOCKED</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="statCallbacks">0</div>
                    <div class="stat-card-label">CALLBACKS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="statNotHome">0</div>
                    <div class="stat-card-label">NOT HOME</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="statNoInterest">0</div>
                    <div class="stat-card-label">NO INTEREST</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="statRate">0%</div>
                    <div class="stat-card-label">CLOSE RATE</div>
                </div>
            </div>
            <div class="leaderboard">
                <div class="leaderboard-title">TEAM LEADERBOARD</div>
                <div class="leaderboard-item">
                    <div class="leaderboard-rank gold">1</div>
                    <div class="leaderboard-name">Marcus T.</div>
                    <div class="leaderboard-score">4 deals</div>
                </div>
                <div class="leaderboard-item">
                    <div class="leaderboard-rank silver">2</div>
                    <div class="leaderboard-name">You</div>
                    <div class="leaderboard-score" id="yourScore">0 deals</div>
                </div>
                <div class="leaderboard-item">
                    <div class="leaderboard-rank bronze">3</div>
                    <div class="leaderboard-name">Ashley R.</div>
                    <div class="leaderboard-score">1 deal</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Hidden file inputs -->
    <input type="file" accept="image/*" capture="environment" class="hidden" id="billInput" onchange="handlePhoto('bill', this)">
    <input type="file" accept="image/*" capture="environment" class="hidden" id="homeInput" onchange="handlePhoto('home', this)">

    <script>
        // ========================================
        // STATE
        // ========================================
        const DAILY_GOAL = 150;
        let stats = {
            deals: 0,
            callbacks: 0,
            notHome: 0,
            noAnswer: 0,
            noInterest: 0,
            other: 0,
            dnc: 0
        };
        let callbacks = [];
        let allRoutes = [];
        let selectedRoute = null;
        let selectedHousing = null;
        let gpsTracking = false;
        let userMarker = null;
        let photoData = { bill: null, home: null };

        // ========================================
        // MAP SETUP
        // ========================================
        const map = L.map('map', {
            zoomControl: false
        }).setView([37.5, -77.5], 10);

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }).addTo(map);

        // Load LMI zones
        fetch('lmi_auto_qualify_zones.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { fillColor: '#00bfff', fillOpacity: 0.25, color: '#00ffff', weight: 2 },
                    onEachFeature: (f, layer) => {
                        layer.on('click', () => showZoneIntel(f.properties));
                    }
                }).addTo(map);
            }).catch(() => {});

        // Load routes
        fetch('routes_lite.geojson')
            .then(r => r.json())
            .then(data => {
                allRoutes = data.features.map(f => ({
                    id: f.properties.id,
                    location: f.properties.loc,
                    score: f.properties.sc || 70,
                    lmi: f.properties.lm || 70,
                    hh: f.properties.hh || 100,
                    fresh: f.properties.fr || 50,
                    eheat: f.properties.eh || 40,
                    center: f.properties.ct,
                    geometry: f.geometry
                }));
                renderRoutesList();

                // Add route polygons to map
                data.features.forEach(f => {
                    const score = f.properties.sc || 70;
                    const color = score > 75 ? '#00ff88' : score > 50 ? '#ffd93d' : '#ff6b6b';
                    L.geoJSON(f, {
                        style: { fillColor: color, fillOpacity: 0.35, color: color, weight: 2 }
                    }).addTo(map).on('click', () => {
                        const route = allRoutes.find(r => r.id === f.properties.id);
                        if (route) selectRoute(route);
                    });
                });
            }).catch(() => {});

        // ========================================
        // DOOR LOGGING
        // ========================================
        function logDoor(type) {
            stats[type]++;
            updateDisplay();
            saveStats();

            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(type === 'deal' ? [50, 30, 50, 30, 100] : 30);
            }

            // Show toast
            const messages = {
                deal: 'üéâ DEAL CLOSED!',
                callback: 'üìû Callback saved',
                notHome: 'üè† Not home logged',
                noAnswer: 'üö™ No answer',
                noInterest: '‚úã No interest',
                other: 'üìù Logged',
                dnc: 'üö´ DNC marked'
            };
            showToast(messages[type] || 'Logged', type === 'deal' ? 'deal' : type === 'dnc' ? 'warning' : 'success');
        }

        function updateDisplay() {
            const totalDoors = Object.values(stats).reduce((a, b) => a + b, 0);
            const closeRate = totalDoors > 0 ? Math.round(stats.deals / totalDoors * 100) : 0;
            const progress = Math.min(100, (totalDoors / DAILY_GOAL) * 100);

            document.getElementById('doorCount').textContent = totalDoors;
            document.getElementById('dealsCount').textContent = stats.deals;
            document.getElementById('closeRate').textContent = closeRate + '%';
            document.getElementById('doorProgress').style.width = progress + '%';

            // Stats modal
            document.getElementById('statDeals').textContent = stats.deals;
            document.getElementById('statDoors').textContent = totalDoors;
            document.getElementById('statCallbacks').textContent = stats.callbacks;
            document.getElementById('statNotHome').textContent = stats.notHome;
            document.getElementById('statNoInterest').textContent = stats.noInterest;
            document.getElementById('statRate').textContent = closeRate + '%';
            document.getElementById('yourScore').textContent = stats.deals + ' deals';
        }

        // ========================================
        // CALLBACKS
        // ========================================
        function openCallbackModal() {
            document.getElementById('callbackModal').classList.add('active');
            navigator.geolocation?.getCurrentPosition(pos => {
                // Could auto-fill address based on location
            });
        }

        function selectHousing(btn) {
            document.querySelectorAll('.housing-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedHousing = btn.dataset.type;
        }

        function capturePhoto(type) {
            document.getElementById(type + 'Input').click();
        }

        function handlePhoto(type, input) {
            if (input.files && input.files[0]) {
                photoData[type] = input.files[0];
                document.getElementById(type + 'PhotoBtn').classList.add('has-photo');
                document.getElementById(type + 'PhotoBtn').querySelector('.icon').textContent = '‚úì';
            }
        }

        function saveCallback() {
            const callback = {
                id: Date.now(),
                name: document.getElementById('cbName').value || 'Unknown',
                phone: document.getElementById('cbPhone').value,
                address: document.getElementById('cbAddress').value,
                housing: selectedHousing,
                notes: document.getElementById('cbNotes').value,
                hasBillPhoto: !!photoData.bill,
                hasHomePhoto: !!photoData.home,
                timestamp: new Date().toISOString(),
                location: null
            };

            // Get current location
            navigator.geolocation?.getCurrentPosition(pos => {
                callback.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            });

            callbacks.push(callback);
            stats.callbacks++;
            saveStats();
            saveCallbacks();
            updateDisplay();
            renderCallbacksList();
            closeModal('callbackModal');
            showToast('üìû Callback saved!', 'success');

            // Reset form
            document.getElementById('cbName').value = '';
            document.getElementById('cbPhone').value = '';
            document.getElementById('cbAddress').value = '';
            document.getElementById('cbNotes').value = '';
            document.querySelectorAll('.housing-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.photo-btn').forEach(b => {
                b.classList.remove('has-photo');
                b.querySelector('.icon').textContent = b.id === 'billPhotoBtn' ? 'üìÑ' : 'üè†';
            });
            selectedHousing = null;
            photoData = { bill: null, home: null };
        }

        function renderCallbacksList() {
            const container = document.getElementById('callbacksList');
            document.getElementById('callbackCount').textContent = callbacks.length;

            if (callbacks.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:2rem;">No callbacks yet today</div>';
                return;
            }

            container.innerHTML = callbacks.map(cb => `
                <div class="callback-item">
                    <div class="callback-info">
                        <div class="callback-name">${cb.name}</div>
                        <div class="callback-notes">${cb.address || 'No address'} ${cb.notes ? '‚Ä¢ ' + cb.notes.substring(0, 30) + '...' : ''}</div>
                    </div>
                    <div class="callback-actions">
                        ${cb.phone ? `<button class="callback-btn call" onclick="callNumber('${cb.phone}')">üìû</button>` : ''}
                        ${cb.location ? `<button class="callback-btn nav" onclick="navigateTo(${cb.location.lat}, ${cb.location.lng})">üß≠</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function callNumber(phone) {
            window.location.href = 'tel:' + phone.replace(/\D/g, '');
        }

        function navigateTo(lat, lng) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        // ========================================
        // ROUTES
        // ========================================
        function renderRoutesList() {
            const container = document.getElementById('routesList');
            container.innerHTML = allRoutes.slice(0, 50).map(r => {
                const scoreClass = r.score > 75 ? '' : r.score > 50 ? 'medium' : 'low';
                return `
                    <div class="route-item ${selectedRoute?.id === r.id ? 'selected' : ''}" onclick="selectRoute(allRoutes.find(x => x.id === '${r.id}'))">
                        <div class="route-item-score ${scoreClass}">${r.score}</div>
                        <div class="route-item-info">
                            <div class="route-item-name">${r.id}</div>
                            <div class="route-item-meta">${r.location} ‚Ä¢ ${r.hh} homes</div>
                            <div class="route-item-badges">
                                <span class="zone-badge lmi">LMI ${r.lmi}%</span>
                                ${r.lmi > 70 ? '<span class="zone-badge auto-qualify">AUTO-QUALIFY</span>' : ''}
                                ${r.fresh > 80 ? '<span class="zone-badge fresh">FRESH</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectRoute(route) {
            selectedRoute = route;
            closeModal('routesModal');

            // Show zone intel
            showZoneIntel({
                zone_id: route.id,
                location: route.location,
                score: route.score,
                lmi: route.lmi,
                hh: route.hh,
                fresh: route.fresh,
                eheat: route.eheat
            });

            // Pan to route
            if (route.center) {
                map.setView(route.center, 14);
            }

            renderRoutesList();
        }

        function showZoneIntel(props) {
            const intel = document.getElementById('zoneIntel');
            intel.classList.add('active');

            document.getElementById('zoneName').textContent = props.location || props.zone_id || 'Zone';

            const score = props.score || 70;
            const scoreEl = document.getElementById('zoneScore');
            scoreEl.textContent = score;
            scoreEl.className = 'zone-score' + (score > 75 ? '' : score > 50 ? ' medium' : ' low');

            // Build badges
            const lmi = props.lmi || props.avg_pct_low_income * 100 || 50;
            let badges = `<span class="zone-badge lmi">LMI ${Math.round(lmi)}%</span>`;
            if (lmi > 70) badges += '<span class="zone-badge auto-qualify">AUTO-QUALIFY</span>';
            if (props.fresh > 80) badges += '<span class="zone-badge fresh">FRESH ZONE</span>';
            if (props.eheat > 60) badges += '<span class="zone-badge electric">HIGH BILLS</span>';
            document.getElementById('zoneBadges').innerHTML = badges;

            // Smart pitch line
            let pitch = '"You already qualify for the $6,000 federal rebate"';
            if (lmi > 70) pitch = '"Great news - you automatically qualify for the full $6,000!"';
            else if (props.eheat > 60) pitch = '"I can cut your electric bill in half - can I see a recent bill?"';
            else if (props.fresh > 80) pitch = '"We\'re just introducing solar savings to this neighborhood"';
            document.getElementById('pitchLine').textContent = pitch;
        }

        // ========================================
        // GPS
        // ========================================
        function toggleGPS() {
            gpsTracking = !gpsTracking;
            const btn = document.getElementById('gpsBtn');

            if (gpsTracking) {
                btn.classList.add('tracking');
                navigator.geolocation.watchPosition(
                    pos => {
                        const loc = [pos.coords.latitude, pos.coords.longitude];
                        if (userMarker) {
                            userMarker.setLatLng(loc);
                        } else {
                            userMarker = L.circleMarker(loc, {
                                radius: 8,
                                fillColor: '#00d4ff',
                                fillOpacity: 1,
                                color: 'white',
                                weight: 3
                            }).addTo(map);
                        }
                        map.setView(loc, 16);
                    },
                    () => showToast('Location error', 'warning'),
                    { enableHighAccuracy: true }
                );
            } else {
                btn.classList.remove('tracking');
                if (userMarker) {
                    map.removeLayer(userMarker);
                    userMarker = null;
                }
            }
        }

        // ========================================
        // PANELS & MODALS
        // ========================================
        function showPanel(panel) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav' + panel.charAt(0).toUpperCase() + panel.slice(1)).classList.add('active');

            if (panel === 'routes') {
                document.getElementById('routesModal').classList.add('active');
            } else if (panel === 'callbacks') {
                renderCallbacksList();
                document.getElementById('callbacksModal').classList.add('active');
            } else if (panel === 'stats') {
                document.getElementById('statsModal').classList.add('active');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('navMap').classList.add('active');
        }

        // ========================================
        // TOAST
        // ========================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ========================================
        // PERSISTENCE
        // ========================================
        function saveStats() {
            localStorage.setItem('emg_stats_' + new Date().toDateString(), JSON.stringify(stats));
        }

        function saveCallbacks() {
            localStorage.setItem('emg_callbacks_' + new Date().toDateString(), JSON.stringify(callbacks));
        }

        function loadData() {
            const savedStats = localStorage.getItem('emg_stats_' + new Date().toDateString());
            if (savedStats) stats = JSON.parse(savedStats);

            const savedCallbacks = localStorage.getItem('emg_callbacks_' + new Date().toDateString());
            if (savedCallbacks) callbacks = JSON.parse(savedCallbacks);

            updateDisplay();
            renderCallbacksList();
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
