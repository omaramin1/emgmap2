<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EMG Field Rep</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg: #0a0a12;
            --card: #12121f;
            --accent: #00d4ff;
            --success: #00ff88;
            --warning: #ffd93d;
            --danger: #ff6b6b;
            --text: #ffffff;
            --muted: #666680;
            --gold: #ffd700;
        }
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            touch-action: manipulation;
        }

        .app { display: flex; flex-direction: column; height: 100%; }

        /* ===== HEADER ===== */
        .header {
            background: var(--card);
            padding: 0.75rem 1rem;
            padding-top: calc(0.75rem + env(safe-area-inset-top));
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .door-counter {
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }
        .door-count {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success);
        }
        .door-goal {
            font-size: 1rem;
            color: var(--muted);
        }
        .header-stats {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        .header-stat {
            text-align: center;
        }
        .header-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        .header-stat-value.deals { color: var(--success); }
        .header-stat-value.callbacks { color: var(--warning); }
        .header-stat-label {
            font-size: 0.55rem;
            color: var(--muted);
            text-transform: uppercase;
        }

        /* ===== MAP ===== */
        .map-container {
            flex: 1;
            position: relative;
        }
        #map { width: 100%; height: 100%; }

        /* Center crosshair for pin dropping */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            pointer-events: none;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* GPS button */
        .gps-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--card);
            border: 2px solid var(--accent);
            color: var(--accent);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .gps-btn.active {
            background: var(--accent);
            color: var(--bg);
        }

        /* Address display */
        .address-bar {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            z-index: 1000;
            background: rgba(18,18,31,0.95);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .address-text {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .address-meta {
            font-size: 0.7rem;
            color: var(--muted);
        }

        /* ===== PIN BUTTONS ===== */
        .pin-section {
            background: var(--card);
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .pin-instruction {
            text-align: center;
            font-size: 0.75rem;
            color: var(--muted);
            margin-bottom: 0.75rem;
        }

        .pin-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }
        .pin-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 12px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            transition: transform 0.1s;
        }
        .pin-btn:active { transform: scale(0.9); }
        .pin-btn .label {
            font-size: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pin-btn.deal { background: var(--success); color: var(--bg); }
        .pin-btn.callback { background: var(--warning); color: var(--bg); }
        .pin-btn.not-home { background: #555; color: white; }
        .pin-btn.no-interest { background: var(--danger); color: white; }
        .pin-btn.not-qualified { background: #8B4513; color: white; }
        .pin-btn.dnc { background: #1a1a1a; color: var(--danger); border: 2px solid var(--danger); }

        /* ===== CALLBACK MODAL ===== */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 5000;
            display: none;
            align-items: flex-end;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card);
            width: 100%;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg);
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .form-group { margin-bottom: 0.75rem; }
        .form-label { display: block; font-size: 0.7rem; color: var(--muted); margin-bottom: 0.25rem; }
        .form-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.9rem;
        }
        .form-row { display: flex; gap: 0.5rem; }
        .form-row .form-group { flex: 1; }

        .submit-btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 10px;
            background: var(--warning);
            color: var(--bg);
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            top: calc(1rem + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--card);
            padding: 0.6rem 1.25rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 9999;
            transition: transform 0.3s;
            border: 2px solid var(--success);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.deal { background: var(--success); color: var(--bg); border-color: var(--success); }
        .toast.callback { background: var(--warning); color: var(--bg); border-color: var(--warning); }
        .toast.dnc { border-color: var(--danger); }

        /* Pin markers on map - NEW (today's pins) */
        .pin-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.5);
        }
        .pin-marker.deal { background: var(--success); }
        .pin-marker.callback { background: var(--warning); }
        .pin-marker.not-home { background: #555; }
        .pin-marker.no-interest { background: var(--danger); }
        .pin-marker.not-qualified { background: #8B4513; }
        .pin-marker.dnc { background: #1a1a1a; border-color: var(--danger); }

        /* Historical pins - smaller, faded */
        .pin-marker.historical {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.5);
            font-size: 10px;
            opacity: 0.7;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Legend */
        .legend {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: rgba(18,18,31,0.95);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.65rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.25rem;
        }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid white;
        }
        .legend-dot.historical { opacity: 0.5; width: 8px; height: 8px; }
        .legend-dot.deal { background: var(--success); }
        .legend-dot.callback { background: var(--warning); }
        .legend-dot.dnc { background: #1a1a1a; border-color: var(--danger); }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header with counts -->
        <header class="header">
            <div class="door-counter">
                <span class="door-count" id="doorCount">0</span>
                <span class="door-goal">/ 150</span>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value deals" id="dealCount">0</div>
                    <div class="header-stat-label">Deals</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value callbacks" id="callbackCount">0</div>
                    <div class="header-stat-label">Callbacks</div>
                </div>
            </div>
        </header>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <div class="crosshair">üìç</div>
            <button class="gps-btn" id="gpsBtn" onclick="centerOnMe()">üìç</button>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background:#00ff88"></div>
                    <span>New Deal</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background:#ffd93d"></div>
                    <span>Callback</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot historical" style="background:#00cc66"></div>
                    <span style="color:var(--muted)">Valid (old)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot historical" style="background:#cc9900"></div>
                    <span style="color:var(--muted)">Pending</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot historical" style="background:#cc3333"></div>
                    <span style="color:var(--muted)">Invalid</span>
                </div>
            </div>

            <div class="address-bar" id="addressBar">
                <div class="address-text" id="addressText">Tap map to select location</div>
                <div class="address-meta" id="addressMeta">Move map to position pin</div>
            </div>
        </div>

        <!-- Pin buttons -->
        <section class="pin-section">
            <div class="pin-instruction">DROP PIN AT CROSSHAIR</div>
            <div class="pin-buttons">
                <button class="pin-btn deal" onclick="dropPin('deal')">
                    <span>üí∞</span>
                    <span class="label">Deal</span>
                </button>
                <button class="pin-btn callback" onclick="openCallback()">
                    <span>üìû</span>
                    <span class="label">Callback</span>
                </button>
                <button class="pin-btn not-home" onclick="dropPin('not-home')">
                    <span>üè†</span>
                    <span class="label">Not Home</span>
                </button>
                <button class="pin-btn no-interest" onclick="dropPin('no-interest')">
                    <span>‚úã</span>
                    <span class="label">No Int</span>
                </button>
                <button class="pin-btn not-qualified" onclick="dropPin('not-qualified')">
                    <span>‚ùå</span>
                    <span class="label">Not Qual</span>
                </button>
                <button class="pin-btn dnc" onclick="dropPin('dnc')">
                    <span>üö´</span>
                    <span class="label">DNC</span>
                </button>
            </div>
        </section>
    </div>

    <!-- Callback Modal -->
    <div class="modal" id="callbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìû Save Callback</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="cbName" placeholder="Homeowner">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="cbPhone" placeholder="555-555-5555">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <input type="text" class="form-input" id="cbNotes" placeholder="Best time, interests...">
            </div>
            <button class="submit-btn" onclick="saveCallback()">Save Callback & Drop Pin</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ========================================
        // STATE
        // ========================================
        let pins = [];  // Today's pins
        let historicalPins = [];  // Old pins from data file
        let stats = { deal: 0, callback: 0, 'not-home': 0, 'no-interest': 0, 'not-qualified': 0, dnc: 0 };
        let currentLocation = null;
        let userMarker = null;

        const icons = {
            // Today's pins
            'deal': 'üí∞', 'callback': 'üìû', 'not-home': 'üè†',
            'no-interest': '‚úã', 'not-qualified': '‚ùå', 'dnc': 'üö´',
            // Historical statuses
            'complete': '‚úì', 'pending': '‚è≥', 'invalid': '‚úó',
            'old-deal': 'üí∞', 'old-callback': 'üìû', 'old-dnc': 'üö´'
        };
        const colors = {
            // Today's pins - BRIGHT
            'deal': '#00ff88',           // Bright green
            'callback': '#ffd93d',       // Bright yellow
            'not-home': '#555555',       // Gray
            'no-interest': '#ff6b6b',    // Red
            'not-qualified': '#8B4513',  // Brown
            'dnc': '#1a1a1a',            // Black
            // Historical - Valid
            'complete': '#00cc66',       // Green (valid old deal)
            'old-deal': '#00cc66',
            // Historical - Pending
            'pending': '#cc9900',        // Orange/yellow (needs follow-up)
            'old-callback': '#cc9900',
            // Historical - Invalid
            'invalid': '#cc3333',        // Red (bad lead)
            'old-dnc': '#660000'         // Dark red
        };

        // ========================================
        // MAP SETUP
        // ========================================
        const map = L.map('map', { zoomControl: false }).setView([37.5, -77.5], 15);

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 20
        }).addTo(map);

        // Load LMI zones as background
        fetch('lmi_auto_qualify_zones.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { fillColor: '#00bfff', fillOpacity: 0.15, color: '#00ffff', weight: 1 }
                }).addTo(map);
            }).catch(() => {});

        // Load historical pins from data file
        let historicalStats = { complete: 0, pending: 0, invalid: 0 };

        fetch('pins.geojson')
            .then(r => r.json())
            .then(data => {
                if (data.features) {
                    data.features.forEach(f => {
                        const props = f.properties || {};
                        const type = props.type || 'complete';
                        const coords = f.geometry.coordinates;
                        const lat = coords[1];
                        const lng = coords[0];

                        historicalPins.push({ type, lat, lng, historical: true, props });
                        historicalStats[type] = (historicalStats[type] || 0) + 1;

                        // Color based on status
                        const color = colors[type] || colors.complete;
                        const icon = type === 'complete' ? '‚úì' : type === 'pending' ? '‚è≥' : '‚úó';

                        const marker = L.divIcon({
                            className: 'pin-marker-wrapper',
                            html: `<div class="pin-marker historical" style="background:${color}">${icon}</div>`,
                            iconSize: [18, 18],
                            iconAnchor: [9, 9]
                        });

                        const popup = `<b>${type.toUpperCase()}</b><br>
                            ${props.rep || ''}<br>
                            ${props.date || ''}<br>
                            <span style="color:#888">${props.city || ''}</span>`;

                        L.marker([lat, lng], { icon: marker })
                            .addTo(map)
                            .bindPopup(popup);
                    });
                    updateAddress();
                    console.log('Loaded historical pins:', historicalStats);
                }
            }).catch(e => {
                console.log('No historical pins file or error:', e);
            });

        // Update address on map move
        map.on('moveend', updateAddress);
        map.on('move', updateAddress);

        function updateAddress() {
            const center = map.getCenter();
            document.getElementById('addressText').textContent =
                `${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}`;

            const valid = historicalPins.filter(p => p.type === 'complete').length;
            const pending = historicalPins.filter(p => p.type === 'pending').length;

            document.getElementById('addressMeta').textContent =
                `Today: ${pins.length} | Old: ${valid} valid, ${pending} pending`;
        }

        // ========================================
        // GPS
        // ========================================
        function centerOnMe() {
            const btn = document.getElementById('gpsBtn');
            btn.classList.add('active');

            navigator.geolocation.getCurrentPosition(
                pos => {
                    const loc = [pos.coords.latitude, pos.coords.longitude];
                    currentLocation = loc;
                    map.setView(loc, 18);

                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.circleMarker(loc, {
                        radius: 8,
                        fillColor: '#00d4ff',
                        fillOpacity: 1,
                        color: 'white',
                        weight: 3
                    }).addTo(map).bindPopup('You are here');

                    btn.classList.remove('active');
                },
                () => {
                    showToast('Location error', '');
                    btn.classList.remove('active');
                },
                { enableHighAccuracy: true }
            );
        }

        // ========================================
        // PIN DROPPING
        // ========================================
        function dropPin(type, callbackData = null) {
            const center = map.getCenter();
            const pin = {
                id: Date.now(),
                type: type,
                lat: center.lat,
                lng: center.lng,
                timestamp: new Date().toISOString(),
                callback: callbackData
            };

            pins.push(pin);
            stats[type]++;

            // Add marker to map (larger for today's pins)
            const marker = L.divIcon({
                className: 'pin-marker-wrapper',
                html: `<div class="pin-marker ${type}" style="background:${colors[type]}">${icons[type]}</div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            L.marker([pin.lat, pin.lng], { icon: marker })
                .addTo(map)
                .bindPopup(`<b>${type.toUpperCase()}</b><br>${new Date().toLocaleTimeString()}<br><span style="color:var(--success)">Today</span>`);

            // Update display
            updateDisplay();
            saveData();

            // Feedback
            if (navigator.vibrate) {
                navigator.vibrate(type === 'deal' ? [50, 30, 50, 30, 100] : 40);
            }

            const messages = {
                'deal': 'üí∞ DEAL!',
                'callback': 'üìû Callback saved',
                'not-home': 'üè† Not home',
                'no-interest': '‚úã No interest',
                'not-qualified': '‚ùå Not qualified',
                'dnc': 'üö´ DNC marked'
            };
            showToast(messages[type], type);
        }

        function updateDisplay() {
            const total = Object.values(stats).reduce((a, b) => a + b, 0);
            document.getElementById('doorCount').textContent = total;
            document.getElementById('dealCount').textContent = stats.deal;
            document.getElementById('callbackCount').textContent = stats.callback;
            updateAddress();
        }

        // ========================================
        // CALLBACKS
        // ========================================
        function openCallback() {
            document.getElementById('callbackModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('callbackModal').classList.remove('active');
        }

        function saveCallback() {
            const data = {
                name: document.getElementById('cbName').value || 'Unknown',
                phone: document.getElementById('cbPhone').value,
                notes: document.getElementById('cbNotes').value
            };

            dropPin('callback', data);
            closeModal();

            // Clear form
            document.getElementById('cbName').value = '';
            document.getElementById('cbPhone').value = '';
            document.getElementById('cbNotes').value = '';
        }

        // ========================================
        // TOAST
        // ========================================
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // ========================================
        // PERSISTENCE
        // ========================================
        function saveData() {
            const today = new Date().toDateString();
            localStorage.setItem('emg_pins_' + today, JSON.stringify(pins));
            localStorage.setItem('emg_stats_' + today, JSON.stringify(stats));
        }

        function loadData() {
            const today = new Date().toDateString();

            const savedPins = localStorage.getItem('emg_pins_' + today);
            if (savedPins) {
                pins = JSON.parse(savedPins);
                // Recreate markers for today's pins
                pins.forEach(pin => {
                    const marker = L.divIcon({
                        className: 'pin-marker-wrapper',
                        html: `<div class="pin-marker ${pin.type}" style="background:${colors[pin.type]}">${icons[pin.type]}</div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });
                    L.marker([pin.lat, pin.lng], { icon: marker })
                        .addTo(map)
                        .bindPopup(`<b>${pin.type.toUpperCase()}</b><br><span style="color:var(--success)">Today</span>`);
                });
            }

            const savedStats = localStorage.getItem('emg_stats_' + today);
            if (savedStats) {
                stats = JSON.parse(savedStats);
            }

            updateDisplay();
        }

        // Initialize
        loadData();
        centerOnMe();
    </script>
</body>
</html>
